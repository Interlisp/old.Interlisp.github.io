<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Interlisp Bibliography</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.css"
    />
    <!-- Theme fonts -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Lato:400,700"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Montserrat:400,700"
    />
    <!-- end fonts -->
    <link rel="stylesheet" href="../theme.css" />

    <style>
      table {
        table-layout: fixed;
        word-wrap: break-word;
      }
    </style>
  </head>
  <body data-spy="scroll" data-target="#toc">
    <!-- START: Header -->
    <header class="site-header">
      <div class="container text-center text-md-left">
        <div class="personal-info clearfix">
          <a href="#">
            <img
              src="../images/Interlisp-D.png"
              class="float-left"
              alt="Interlisp-D logo showing windows"
              width="50"
              height="50"
          /></a>
          <div class="infos float-left">
            <h1><a href="/">Medley Interlisp Project</a></h1>
            <p class="p-info">
              Email:
              <a href="mailto:Interlisp@googlegroups.com"
                >Interlisp@googlegroups.com</a
              >
              <a
                href="https://groups.google.com/forum/#!topic/interlisp/jq0dJQEWDkU"
                >(archives)</a
              ><br />
              Links:
              <a target="_blank" href="https://github.com/Interlisp"
                >github.com/Interlisp</a
              >,
              <a target="_blank" href="https://en.wikipedia.org/wiki/Interlisp"
                >Wikipedia on Interlisp</a
              >
            </p>
          </div>
        </div>
      </div>
    </header>
    <main class="site-main">
      <div class="container">
        <div class="row">
          <div class="col-sm-12">
            <h2>Bibliography</h2>
            <table id="bib" class="table">
              <tr>
                <td class="text-center">
                  <div class="spinner-border" role="status">
                    <span class="sr-only">Loading...</span>
                  </div>
                </td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </main>
    <!-- START: JS -->
    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
      integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
      integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script>
    <script src="citeproc.js"></script>

    <script>
      async function initializeEngine(retrieveItem) {
        const locales = {
          "en-US": await fetch("locales-en-US.xml").then((response) =>
            response.text()
          ),
        };

        const style = await fetch("simple.csl").then((response) =>
          response.text()
        );

        return new CSL.Engine(
          {
            retrieveLocale: (lang) => locales[lang],
            retrieveItem,
          },
          style
        );
      }

      function reorganizeCslJson(rawData) {
        var citations = {};

        for (var citation of rawData["items"]) {
          citations[citation.id] = citation;
        }

        return citations;
      }

      async function fetchAllItems(srcUrl, start = 0) {
        var cslJsonResponse = await fetch(
          srcUrl +
            `?itemType=-attachment&format=csljson&sort=date&direction=asc&limit=100&start=${start}`
        );
        var total = parseInt(cslJsonResponse.headers.get("Total-Results"));
        var citations = reorganizeCslJson(await cslJsonResponse.json());
        if (start + 100 < total)
          Object.assign(citations, await fetchAllItems(srcUrl, start + 100));
        return citations;
      }

      function extractAnnotation(extra) {
        if (!extra) return "";
        var matches = extra.match(/^Annotation: (.*)/);
        return matches ? matches[1] : "";
      }

      /**
       * Load a CSL JSON file and display it in a table.
       * @param {HTMLTableElement} table The HTML table to fill. Will be cleared.
       * @param {String} srcUrl The URL to load the CSL JSON from.
       */
      async function loadBibliography(table) {
        var citations = await fetchAllItems(
			  "https://api.zotero.org/groups/2914042/collections/3CNYFDHF/items"
        );

        var engine = await initializeEngine((id) => citations[id]);

        table.innerHTML =
          "<thead><tr><th>Citation</th><th>Note</th></tr></thead>";
        var tbody = document.createElement("tbody");
        engine.updateItems(Object.keys(citations));
        var bibliography = engine.makeBibliography();
        var ids = bibliography[0].entry_ids;
        bibliography[1].forEach((generatedHTML, i) => {
          var citation = citations[ids[i]];
          var metadataRow = document.createElement("tr");

          var citationCell = document.createElement("td");
          if (citation.URL) {
            var citationLink = document.createElement("a");
            citationLink.href = citation.URL;
            citationLink.innerHTML = generatedHTML;
            citationCell.appendChild(citationLink);
          } else {
            citationCell.innerHTML = generatedHTML;
          }
          citationCell.style = "word-wrap: break-word";
          metadataRow.appendChild(citationCell);

          var fullTextCell = document.createElement("td");
          fullTextCell.innerText = extractAnnotation(citation.note) || "";
          metadataRow.appendChild(fullTextCell);

          tbody.appendChild(metadataRow);
        });
        table.appendChild(tbody);
      }

      var table = document.getElementById("bib");
      loadBibliography(table);
    </script>
  </body>
</html>
